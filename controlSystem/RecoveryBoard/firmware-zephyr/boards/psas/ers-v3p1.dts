/*
 * Copyright (c) 2025 Portland State Aerospace Society (PSAS)
 *
 * SPDX-License-Identifier: Apache-2.0
 */

/dts-v1/;
#include <st/f0/stm32f091Xc.dtsi>
#include <st/f0/stm32f091r(b-c)tx-pinctrl.dtsi>
#include <zephyr/dt-bindings/input/input-event-codes.h>

// TODO [ ] determine whether needed and how used:
// #include <zephyr/dt-bindings/input/input-event-codes.h>

// Excerpt from https://docs.google.com/document/d/1DnytDlZa1X-BaIqlIBrfcuedKocKrCpTfgMspk0twxI/edit?tab=t.0#heading=h.yycwig6l5oeu

// --- EXCERPT BEGIN ---

// Pin Configuration
// -------------------
// Shared
// [x] !UMB_ON (PA8 = GPIO input)
// [x] BATT_READ (PB0 = analog input ADC_IN8)          . . . analog input PB0
// [ ] Buzzer (PB15 = GPIO output low / PWM)
// [x] SERIAL OUT (PA2 = UART2_TX @ 115200 bps 8N1)
// [x] SERIAL IN (PA3 = UART2_RX @ 115200 bps 8N1)
// [x] CAN_TX (PA12 = CAN TXD)
// [x] CAN_RX (PA11 = CAN_RX)
// [ ] CAN_SHDN (PA10 = GPIO output low)
// [ ] CAN_SLIENT (PA9 = GPIO output low)
// [ ] !MOTOR_PS (PB6 = GPIO output low)
// Everything else
// [ ] GPIO input with pulldown enabled

// Sender PCB 
// [x] ISO_DROGUE (PA5 = GPIO input)
// [x] ISO_MAIN  (PA6 = GPIO input)
// [x] ROCKET_READY (PA7 = GPIO output low)

// ERS PCBs
// [ ] DEPLOY1 (PB4 = GPIO output low)
// [ ] DEPLOY2 (PB5 = GPIO output low)
// [ ] !MOTOR_FAILA (PB7 = GPIO input)
// [ ] MOTOR_ILIM (PA4 = DAC output)
// [?] MOTOR_ISENSE (PB1 = Analog input ADC_IN9)       . . . analog input PB1
// [x] HALL1 (PA0 = Analog input ADC_IN0)              . . . analog input PA0
// [x] HALL2 (PA1 = Analog input ADC_IN1)              . . . analog input PA1

// --- EXCERPT END ---

// Notes:
//  +  only GPIO ports A and B used on ERS board
//  +  nucleo_f091rc.dts references &gpioa and &gpioc

/ {
        model = "ERS V3.1 board";
        compatible = "st,stm32f091rc-nucleo";

        chosen {
                zephyr,console = &usart2;
                zephyr,shell-uart = &usart2;
                zephyr,sram = &sram0;
                zephyr,flash = &flash0;
	};

	ers-gpios {
		compatible = "psas,ers-gpios";

		led_orange: led_orange {
			gpios = <&gpiob 14 0>;
		};

		not_umb_on: not_umb_on {
			gpios = <&gpioa 8 0>;
		};

		batt_read: batt_read {
			gpios = <&gpiob 6 0>;
		};

		can_shdn: can_shdn {
			gpios = <&gpioa 10 0>;
		};

		can_silent: can_silent {
			gpios = <&gpioa 9 0>;
		};

		not_motor_ps: not_motor_ps {
			gpios = <&gpiob 6 0>;
		};

		iso_drogue: iso_drogue {
			gpios = <&gpioa 5 0>;
		};

		iso_main: iso_main {
			gpios = <&gpioa 6 0>;
		};

		rocket_ready: rocket_ready {
			gpios = <&gpioa 7 0>;
		};
	};

        pwmleds: pwmleds {
                compatible = "pwm-leds";
                /* NOTE: disabled by default, PWM2 conflicts with SPI1 */
                status = "disabled";

                pwm_led_orange: pwm_led_orange {
                        pwms = <&pwm2 1 PWM_MSEC(20) PWM_POLARITY_NORMAL>;
                };
        };

	aliases {
                led0 = &led_orange;
                pwm-led0 = &pwm_led_orange;
	};
};

/*
*/
&clk_hse {
        /delete-property/ hse-bypass;
        clock-frequency = <DT_FREQ_M(16)>; // ERS board 16MHz crystal
        status = "okay";
};

// - DEV 0822 - appears to be needed as clock source in
// zephyr/drivers/clock_control/clock_stm32_ll_common.c routine set_up_plls()
&clk_lsi {
        status = "okay";
};

&pll {
        prediv = <1>;
        mul = <3>;
        clocks = <&clk_hse>;
        status = "okay";
};

&rcc {
        clocks = <&pll>;
        clock-frequency = <DT_FREQ_M(48)>;
        ahb-prescaler = <1>;
        apb1-prescaler = <1>;
        status = "okay";
};

&usart2 {
        pinctrl-0 = <&usart2_tx_pa2 &usart2_rx_pa3>;
        pinctrl-names = "default";
        current-speed = <115200>;
        status = "okay";
};

&iwdg {
        status = "okay";
};

&can1 {
        pinctrl-0 = <&can_rx_pa11 &can_tx_pa12>;
        pinctrl-names = "default";
        status = "okay";
};

&flash0 {
        partitions {
                compatible = "fixed-partitions";
                #address-cells = <1>;
                #size-cells = <1>;

//                /* Set 6Kb of storage at the end of the 256Kb of flash */
//                storage_partition: partition@3e800 {
//                        label = "storage";
//                        reg = <0x0003e800 DT_SIZE_K(6)>;
//                };
        };
};

&adc1 {
        pinctrl-0 = <&adc_in0_pa0>;
        pinctrl-names = "default";
        st,adc-clock-source = <SYNC>;
        st,adc-prescaler = <4>;
        status = "okay";
};

&timers15 {
        st,prescaler = <10000>;
        status = "okay";

        pwm2: pwm {
                /* NOTE: disabled by default, PWM2 conflicts with SPI1 */
                // pinctrl-0 = <&tim15_ch2_pb15>;
                pinctrl-0 = <&tim15_ch1_pb14>;
                pinctrl-names = "default";
        };
};
